class TimerManager: ObservableObject {
    static let shared = TimerManager()
    
    @Published var countdownSeconds: Int = 0
    @Published var isTimerActive: Bool = false
    
    private var cancellable: AnyCancellable?

    func startTimer(minutes: Int) {
        countdownSeconds = minutes * 60
        isTimerActive = true
        
        // 全局只有一个计时器在运行
        cancellable = Timer.publish(every: 1, on: .main, in: .common)
            .autoconnect()
            .sink { [weak self] _ in
                self?.updateCountdown()
            }
    }

    private func updateCountdown() {
        guard isTimerActive && countdownSeconds > 0 else {
            if countdownSeconds == 0 { stopTimer() }
            return
        }
        countdownSeconds -= 1
        
        if countdownSeconds == 0 {
            stopTimer()
            AudioManager.shared.isPlaying = false // 倒计时结束停止音频
        }
    }

    func stopTimer() {
        isTimerActive = false
        cancellable?.cancel()
    }
    
    // 格式化时间显示
    func timeString() -> String {
        let minutes = countdownSeconds / 60
        let seconds = countdownSeconds % 60
        return String(format: "%02d:%02d", minutes, seconds)
    }
}




// 在 ContentView 结构体内添加状态
@State private var alarmTime = Date()
@State private var isBlockAppOn = false

// 在 body 的 ZStack 底部插入
if showMainTimerPicker {
    ZStack {
        // 1. 半透明背景
        Color.black.opacity(0.6)
            .ignoresSafeArea()
            .onTapGesture { withAnimation { showMainTimerPicker = false } }

        // 2. 遮罩面板
        VStack(alignment: .leading, spacing: 20) {
            Text("智能闹钟").font(.title.bold()).foregroundColor(.white)
            
            DatePicker("", selection: $alarmTime, displayedComponents: .hourAndMinute)
                .datePickerStyle(.wheel)
                .labelsHidden()
                .colorInvert()
                .frame(maxWidth: .infinity)
            
            // 引用你 PlayPage 里的计算睡眠函数，或者直接写死逻辑
            Text("预计睡眠时间：\(calculateSleepTime(from: alarmTime))")
                .font(.caption)
                .foregroundColor(.gray)
            
            Toggle("拦截干扰应用", isOn: $isBlockAppOn)
                .foregroundColor(.white)
                .padding()
                .background(Color.white.opacity(0.1))
                .cornerRadius(12)
            
            Spacer()
            
            HStack(spacing: 15) {
                Button(action: { withAnimation { showMainTimerPicker = false } }) {
                    Text("取消").frame(maxWidth: .infinity).frame(height: 55)
                        .background(Color.gray.opacity(0.3)).cornerRadius(15).foregroundColor(.white)
                }
                
                Button(action: {
                    // 【关键联动】：调用全局管理器
                    timerManager.startCountdown(from: alarmTime)
                    // 如果有拦截应用的功能需求，可以在这里处理 isBlockAppOn
                    
                    withAnimation { showMainTimerPicker = false }
                }) {
                    Text("确认").frame(maxWidth: .infinity).frame(height: 55)
                        .background(Color.white).cornerRadius(15).foregroundColor(.black)
                }
            }
        }
        .padding(25)
        .background(Color(hex: "1A1A1A")) // 保持深色背景
        .cornerRadius(30)
        .padding(.horizontal, 20)
        .frame(height: 550) // 给定一个高度，或者根据内容自适应
        
        // 3. 右上角关闭按钮
        VStack {
            HStack {
                Spacer()
                Button(action: { withAnimation { showMainTimerPicker = false } }) {
                    Image(systemName: "xmark").font(.system(size: 18, weight: .bold)).foregroundColor(.white)
                        .padding(10).background(Color.white.opacity(0.1)).clipShape(Circle())
                }.padding(40)
            }
            Spacer()
        }
    }
    .transition(.asymmetric(insertion: .move(edge: .bottom), removal: .opacity))
    .zIndex(100)
}



private func calculateSleepTime(from targetDate: Date) -> String {
    let now = Date()
    var diff = targetDate.timeIntervalSince(now)
    if diff < 0 { diff += 86400 } // 如果选的是明天
    let hours = Int(diff) / 3600
    let minutes = Int(diff) % 3600 / 60
    return "\(hours)小时\(minutes)分钟"
}



HStack(spacing: 25) {
    Button(action: {
        withAnimation(.spring()) {
            showTimerPicker = true 
        }
    }) {
        Group {
            if timerManager.countdownSeconds > 0 {
                // 倒计时激活状态
                Text(timerManager.timerString()) // 确保带括号 ()
                    .font(.system(size: 14, weight: .bold, design: .monospaced))
                    .foregroundColor(.blue)
            } else {
                // 默认状态
                Image(systemName: "alarm")
                    .foregroundColor(.white.opacity(0.7))
                    .font(.system(size: 20))
            }
        }
    }

    Button(action: {
        withAnimation(.spring(response: 0.35, dampingFraction: 0.7)) {
            audioManager.togglePlayPause()
        }
    }) {
        Image(systemName: audioManager.isPlaying ? "pause.fill" : "play.fill")
            .foregroundColor(.white)
            .font(.system(size: 24))
            .frame(width: 30)
    }
}
